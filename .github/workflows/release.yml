# SPDX-FileCopyrightText: 2026 Giovanni MARIANO
#
# SPDX-License-Identifier: MPL-2.0

name: Release

on:
  release:
    types: [published]

permissions:
  contents: read
  id-token: write

jobs:
  # ── Source distribution ──────────────────────────────────────────────
  build-sdist:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive
      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"
      - name: Build sdist
        run: |
          pip install build
          python -m build --sdist
      - uses: actions/upload-artifact@v4
        with:
          name: dist-sdist
          path: dist/*.tar.gz

  # ── Linux wheels (cibuildwheel) ──────────────────────────────────────
  build-wheels-linux:
    runs-on: ${{ matrix.runner }}
    strategy:
      matrix:
        include:
          - runner: ubuntu-latest
            arch: x86_64
          - runner: ubuntu-24.04-arm
            arch: aarch64
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive
      - uses: pypa/cibuildwheel@v2.22
        env:
          CIBW_ARCHS_LINUX: ${{ matrix.arch }}
      - uses: actions/upload-artifact@v4
        with:
          name: dist-linux-${{ matrix.arch }}
          path: wheelhouse/*.whl

  # ── macOS wheels (cibuildwheel) ──────────────────────────────────────
  build-wheels-macos:
    runs-on: ${{ matrix.runner }}
    strategy:
      matrix:
        include:
          - runner: macos-13
            arch: x86_64
          - runner: macos-latest
            arch: arm64
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive
      - uses: pypa/cibuildwheel@v2.22
        env:
          CIBW_ARCHS_MACOS: ${{ matrix.arch }}
      - uses: actions/upload-artifact@v4
        with:
          name: dist-macos-${{ matrix.arch }}
          path: wheelhouse/*.whl

  # ── Windows wheels (MSYS2 + MinGW) ──────────────────────────────────
  build-wheels-windows:
    runs-on: windows-latest
    strategy:
      matrix:
        python-version: ["3.9", "3.10", "3.11", "3.12", "3.13", "3.14"]
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive
      - uses: msys2/setup-msys2@v2
        with:
          msystem: UCRT64
          install: mingw-w64-ucrt-x86_64-gcc make
      - uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
      - name: Build C library
        shell: msys2 {0}
        run: cd csrc/libalea && make lib RELEASE=1 PORTABLE=1
      - name: Build wheel
        shell: pwsh
        run: |
          $env:PATH = "C:\msys64\ucrt64\bin;$env:PATH"
          pip install build setuptools wheel
          python -m build --wheel
      - name: Test wheel
        shell: pwsh
        run: |
          $env:PATH = "C:\msys64\ucrt64\bin;$env:PATH"
          pip install pytest
          pip install (Get-ChildItem dist/*.whl).FullName
          pytest tests -x
      - uses: actions/upload-artifact@v4
        with:
          name: dist-windows-${{ matrix.python-version }}
          path: dist/*.whl

  # ── Publish to TestPyPI ──────────────────────────────────────────────
  publish-testpypi:
    needs: [build-sdist, build-wheels-linux, build-wheels-macos, build-wheels-windows]
    runs-on: ubuntu-latest
    environment: testpypi
    permissions:
      id-token: write
    steps:
      - uses: actions/download-artifact@v4
        with:
          path: dist
          pattern: dist-*
          merge-multiple: true
      - uses: pypa/gh-action-pypi-publish@release/v1
        with:
          repository-url: https://test.pypi.org/legacy/

  # ── Publish to PyPI (manual approval) ───────────────────────────────
  publish-pypi:
    needs: [publish-testpypi]
    runs-on: ubuntu-latest
    environment: pypi
    permissions:
      id-token: write
    steps:
      - uses: actions/download-artifact@v4
        with:
          path: dist
          pattern: dist-*
          merge-multiple: true
      - uses: pypa/gh-action-pypi-publish@release/v1
